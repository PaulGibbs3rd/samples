import{dN as V,dO as W,dP as Z,dQ as T,dL as x,dM as j,dR as Q,dS as G,aj as J,dT as U,dU as K,dV as X,dW as B}from"./index-HvZUpAiV.js";import{c as Y}from"./fontUtils-CX2ZFjAl.js";import{U as _,k as $}from"./quantizationUtils-DhCYdMlR.js";const H="picture-fill",tt="picture-marker",nt="simple-fill",at="simple-line",it="simple-marker",et="text",ot="Aa",lt=j.size,z=j.maxSize,st=j.maxOutlineSize,O=j.lineWidth,R=225,rt=document.createElement("canvas");function q(n,t,s){if(n.type==="polygon"){const i=n.extent,u=i.width===0?1:i.width,c=i.height===0?1:i.height;n=_({originPosition:"upperLeft",scale:[u/t,c/s],translate:[i.xmin,i.ymax]},{},n);let r="";for(let o=0;o<n.rings.length;o++){const l=n.rings[o];for(let h=0;h<l.length;h++){const p=l[h][0],m=l[h][1];let a="";h===0?(a=`M${p.toString()} ${m.toString()}`,r!==""&&(a=` ${a}`),r+=a):h===l.length-1?(a=`l${p.toString()} ${m.toString()} Z`,r!==""&&(a=` ${a}`),r+=a):(a=`l${p.toString()} ${m.toString()}`,r!==""&&(a=` ${a}`),r+=a)}}return r}if(n.type==="polyline"){const i=n.extent,u=i.width===0?1:i.width,c=i.height===0?1:i.height;n=$({originPosition:"upperLeft",scale:[u/t,c/s],translate:[i.xmin,i.ymax]},{},n);let r="";for(let o=0;o<n.paths.length;o++){const l=n.paths[o];for(let h=0;h<l.length;h++){const p=l[h][0],m=l[h][1];let a="";h===0?(a=`M${p.toString()} ${m.toString()}`,r!==""&&(a=` ${a}`),r+=a):(a=`l${p.toString()} ${m.toString()}`,r!==""&&(a=` ${a}`),r+=a)}}return r}return""}function I(n,t){const s=rt.getContext("2d"),i=[];t&&(t.weight&&i.push(t.weight),t.size&&i.push(t.size+"px"),t.family&&i.push(t.family)),s.font=i.join(" ");const{width:u,actualBoundingBoxLeft:c,actualBoundingBoxRight:r,actualBoundingBoxAscent:o,actualBoundingBoxDescent:l}=s.measureText(n);return{width:Math.ceil(Math.max(u,c+r)),height:Math.ceil(o+l),x:Math.floor(c),y:Math.floor((o-l)/2)}}function k(n){const t=n==null?void 0:n.size;return{width:t!=null&&typeof t=="object"&&"width"in t?x(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?x(t.height):null}}async function ht(n,t){const s=t.fill,i=n.color;if((s==null?void 0:s.type)==="pattern"&&i&&n.type!==H){const u=await X(s.src,i.toCss(!0));s.src=u,t.fill=s}}async function ct(n,t,s,i){var r,o,l;if(!("font"in n)||!n.font||t.shape.type!=="text")return;try{await Y(n.font)}catch{}const{width:u,height:c}=k(i);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:h,height:p,x:m,y:a}=I(t.shape.text,{weight:(r=t.font)==null?void 0:r.weight,size:(o=t.font)==null?void 0:o.size,family:(l=t.font)==null?void 0:l.family});s[0]=u??h,s[1]=c??p,t.shape.x=m,t.shape.y=a;let e="angle"in n?n.angle:null;if((i==null?void 0:i.rotation)!=null&&(e=(e??0)+i.rotation),e){const v=e*(Math.PI/180),L=Math.abs(Math.sin(v)),C=Math.abs(Math.cos(v));s[1]=s[0]*L+s[1]*C}}}function ut(n,t,s,i,u){var c;if(n.haloColor!=null&&n.haloSize!=null){u.masking??(u.masking=s.map(()=>[]));const r=x(n.haloSize);i[0]+=r,i[1]+=r,s.unshift([{...t,fill:null,stroke:{color:n.haloColor,width:2*r,join:"round",cap:"round"}}]),u.masking.unshift([{shape:{type:"rect",x:0,y:0,width:i[0]+2*B,height:i[1]+2*B},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}n.backgroundColor==null&&n.borderLineColor==null||(i[0]+=2*B,i[1]+=2*B,s.unshift([{shape:{type:"rect",x:0,y:0,width:i[0],height:i[1]},fill:n.backgroundColor,stroke:{color:n.borderLineColor,width:x(n.borderLineSize)}}]),(c=u.masking)==null||c.unshift([]))}function N(n,t){return n>t?"dark":"light"}function dt(n,t){var L,C,A,D,E;const s=typeof(t==null?void 0:t.size)=="number"?t==null?void 0:t.size:null,i=s!=null?x(s):null,u=(t==null?void 0:t.maxSize)!=null?x(t.maxSize):null;let c="angle"in n?n.angle:null;(t==null?void 0:t.rotation)!=null&&(c=(c??0)+t.rotation);const r=V(n);let o=W(n);pt(n,245)!=="dark"||t!=null&&t.ignoreWhiteSymbols||(o={width:.75,...o,color:"#bdc3c7"});let l=null;const h={shape:null,fill:r,stroke:o,offset:[0,0]};o!=null&&o.width&&(o.width=Math.min(o.width,st));const p=(o==null?void 0:o.width)||0;let m=(t==null?void 0:t.size)!=null&&((t==null?void 0:t.scale)==null||(t==null?void 0:t.scale)),a=0,e=0,v=!1;switch(n.type){case it:{const f=n.style,{width:g,height:d}=k(t);let b=g===d&&g!=null?g:i??Math.min(x(n.size),u||z);if((t==null?void 0:t.useMarkerSymbolSize)===!0&&g!==null&&d!==null){const y=Math.min(x(n.size),u||z);b=y>g&&y>d?Math.min(g,d):y}switch(a=b,e=b,f){case"circle":h.shape={type:"circle",cx:0,cy:0,r:.5*b},m||(a+=p,e+=p);break;case"cross":h.shape={type:"path",path:[{command:"M",values:[0,.5*e]},{command:"L",values:[a,.5*e]},{command:"M",values:[.5*a,0]},{command:"L",values:[.5*a,e]}]};break;case"diamond":h.shape={type:"path",path:[{command:"M",values:[0,.5*e]},{command:"L",values:[.5*a,0]},{command:"L",values:[a,.5*e]},{command:"L",values:[.5*a,e]},{command:"Z",values:[]}]},m||(a+=p,e+=p);break;case"square":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,0]},{command:"L",values:[a,e]},{command:"L",values:[0,e]},{command:"Z",values:[]}]},m||(a+=p,e+=p),c&&(v=!0);break;case"triangle":h.shape={type:"path",path:[{command:"M",values:[.5*a,0]},{command:"L",values:[a,e]},{command:"L",values:[0,e]},{command:"Z",values:[]}]},m||(a+=p,e+=p),c&&(v=!0);break;case"x":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,e]},{command:"M",values:[a,0]},{command:"L",values:[0,e]}]},c&&(v=!0);break;case"path":h.shape={type:"path",path:n.path||""},m||(a+=p,e+=p),c&&(v=!0),m=!0}break}case at:{const{width:f,height:g}=k(t),d=G(o).reduce((M,S)=>M+S,0),b=d&&Math.ceil(O/d),y=g??i??p,w=f??(d*b||O);if(m=!0,((L=t==null?void 0:t.geometry)==null?void 0:L.type)==="polyline"&&((C=t==null?void 0:t.geometry)==null?void 0:C.extent)){a=w,e=g??a;const M=1e3,S=.15*M;l=[a,e],e=l[0]>l[1]?M*l[1]/l[0]:M,a=l[0]>l[1]?M:M*l[0]/l[1],o!=null&&o.width&&(o.width=o.width*M/(l[1]>l[0]?l[1]:l[0]),o.width>S&&(o.width=S)),h.shape={type:"path",path:q(t.geometry,a,e)}}else a=(t==null?void 0:t.maxSize)!=null?Math.min(w,t.maxSize):w,e=y,o&&(o.width=y),h.shape={type:"path",path:[{command:"M",values:[y/2,e/2]},{command:"L",values:[a-y/2,e/2]}]};break}case H:case nt:{const f=typeof(t==null?void 0:t.symbolConfig)=="object"&&!!((A=t==null?void 0:t.symbolConfig)!=null&&A.isSquareFill),{width:g,height:d}=k(t);a=!f&&g!==d||g==null?i??lt:g,e=!f&&g!==d||d==null?a:d,m||(a+=p,e+=p),m=!0,(D=t==null?void 0:t.geometry)!=null&&D.extent&&((E=t==null?void 0:t.geometry)==null?void 0:E.type)==="polygon"?(l=[a,e],e=l[0]>l[1]?1e3*l[1]/l[0]:1e3,a=l[0]>l[1]?1e3:1e3*l[0]/l[1],h.shape={type:"path",path:q(t.geometry,a,e)}):h.shape=f?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,0]},{command:"L",values:[a,e]},{command:"L",values:[0,e]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:Q.fill[0];break}case tt:{const f=Math.min(x(n.width),u||z),g=Math.min(x(n.height),u||z),{width:d,height:b}=k(t),y=d===b&&d!=null?d:i??Math.max(f,g),w=n.width/n.height;a=w<=1?Math.ceil(y*w):y,e=w<=1?y:Math.ceil(y/w),h.shape={type:"image",x:-Math.round(a/2),y:-Math.round(e/2),width:a,height:e,src:n.url||""},c&&(v=!0);break}case et:{const f=n,g=(t==null?void 0:t.overrideText)||f.text||ot,d=f.font,{width:b,height:y}=k(t),w=y??i??Math.min(x(d.size),u||z),{width:M,height:S}=I(g,{weight:d.weight,size:w,family:d.family}),P=/[\uE600-\uE6FF]/.test(g);a=b??(P?w:M),e=P?w:S;let F=.5*(P?w:S);P&&(F+=5),h.shape={type:"text",text:g,x:f.xoffset||0,y:f.yoffset||F,align:"middle",alignBaseline:f.verticalAlignment,decoration:d&&d.decoration,rotated:f.rotated,kerning:f.kerning},h.font=d&&{size:w,style:d.style,decoration:d.decoration,weight:d.weight,family:d.family};break}}return{shapeDescriptor:h,size:[a,e],outputSize:l,renderOptions:{node:t==null?void 0:t.node,scale:m,opacity:t==null?void 0:t.opacity,rotations:[c],useRotationSize:v,effectView:t==null?void 0:t.effectView,ariaLabel:t==null?void 0:t.ariaLabel}}}async function yt(n,t){var l,h,p,m,a;const{shapeDescriptor:s,size:i,renderOptions:u,outputSize:c}=dt(n,t);if(!s.shape)throw new J("symbolPreview: renderPreviewHTML2D","symbol not supported.");await ht(n,s),await ct(n,s,i,t);const r=[[s]];if(typeof(t==null?void 0:t.symbolConfig)=="object"&&((l=t==null?void 0:t.symbolConfig)!=null&&l.applyColorModulation)){const e=.6*i[0];r.unshift([{...s,offset:[-e,0],fill:U(s.fill,-.3)}]),r.push([{...s,offset:[e,0],fill:U(s.fill,.3)}]),i[0]+=2*e,u.scale=!1}n.type==="text"&&ut(n,s,r,i,u);const o=K(r,i,u);if(c&&o){const e=o.nodeName.toLowerCase()==="img"?o:o.firstChild;e.nodeName.toLowerCase()==="svg"&&e.setAttribute("viewBox",`0 0 ${i[0].toString()} ${i[1].toString()}`),e.setAttribute("width",c[0].toString()),e.setAttribute("height",c[1].toString()),c.length>2&&(e.style.setProperty("padding-left",((h=c[2])==null?void 0:h.toString())+"px"),e.style.setProperty("padding-right",((p=c[2])==null?void 0:p.toString())+"px"),e.style.setProperty("padding-top",((m=c[3])==null?void 0:m.toString())+"px"),e.style.setProperty("padding-bottom",((a=c[3])==null?void 0:a.toString())+"px"),e.style.setProperty("box-sizing","border-box"))}return o}function pt(n,t=R){const s=V(n),i=W(n),u=!s||"type"in s?null:new Z(s),c=i!=null&&i.color?new Z(i==null?void 0:i.color):null,r=u?N(T(u),t):null,o=c?N(T(c),t):null;return o?r?r===o?r:t>=R?"light":"dark":o:r}export{pt as getContrastingBackgroundTheme,dt as getRenderSymbolParameters,yt as previewSymbol2D};

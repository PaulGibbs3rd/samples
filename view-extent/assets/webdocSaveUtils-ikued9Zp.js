const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/resourceUtils-CueS85LF.js","assets/index-HvZUpAiV.js","assets/index-CknZVD3U.css","assets/geometryServiceUtils-Cwj9muBm.js"])))=>i.map(i=>d[i]);
import{fk as X,b2 as E,fl as Y,b1 as Z,aj as w,fm as ee,fn as ae,fo as te,fp as g,aO as oe,ak as re,al as ne,fq as c,fr as b,fs as d,ft as se,dG as ie,fu as le,dC as ce,aa as pe,dD as ue,b4 as h,fv as C,fw as fe,fx as de}from"./index-HvZUpAiV.js";import{r as D,t as V,i as me}from"./saveUtils-Dt9HyKPA.js";import{m as we,b as he,d as ye}from"./basemapUtils-TkRYahlU.js";import{getSiblingOfSameTypeI as _e,contentToBlob as _}from"./resourceUtils-CueS85LF.js";async function k(a,e,t){const o=await M(a,e,t);await L(o,e,t)}async function Qe(a,e,t,o,r){const s=await M(t,o,r);await a.update({data:e}),await L(s,o,r)}async function M(a,e,t){if(!(e!=null&&e.resources))return;const o=e.portalItem===a.portalItem?new Set(a.paths):new Set;a.paths.length=0,a.portalItem=e.portalItem;const r=new Set(e.resources.toKeep.map(n=>n.resource.path)),s=new Set,i=[];r.forEach(n=>{o.delete(n),a.paths.push(n)});const l=[],u=[],p=[];for(const n of e.resources.toUpdate)if(o.delete(n.resource.path),r.has(n.resource.path)||s.has(n.resource.path)){const{resource:f,content:Q,finish:R}=n,y=_e(f,X());a.paths.push(y.path),l.push({resource:y,content:await _(Q),compress:n.compress}),R&&p.push(()=>R(y))}else{a.paths.push(n.resource.path),u.push({resource:n.resource,content:await _(n.content),compress:n.compress});const f=n.finish;f&&p.push(()=>f(n.resource)),s.add(n.resource.path)}for(const n of e.resources.toAdd)if(a.paths.push(n.resource.path),o.has(n.resource.path))o.delete(n.resource.path);else{l.push({resource:n.resource,content:await _(n.content),compress:n.compress});const f=n.finish;f&&p.push(()=>f(n.resource))}if(l.length||u.length){const{addOrUpdateResources:n}=await E(()=>import("./resourceUtils-CueS85LF.js"),__vite__mapDeps([0,1,2]));await n(e.portalItem,l,"add",t),await n(e.portalItem,u,"update",t)}if(p.forEach(n=>n()),i.length===0)return o;const m=await Y(i);if(Z(t),m.length>0)throw new w("save:resources","Failed to save one or more resources",{errors:m});return o}async function L(a,e,t){if(!a||!e.portalItem)return;const o=[];for(const r of a){const s=e.portalItem.resourceFromPath(r);o.push(s.portalItem.removeResource(s,t))}await ee(o)}const ge=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(a=>a.toLowerCase());async function be(a,e,t){t??(t={}),Ie(a,e),await g(()=>!e.updatingFromView),await e.load(),await x(e),await D(e),await G(a,e);const o=e.portalItem,{json:r,jsonContext:s}=await v(e,o,a.origin);return V(s,{errorName:`${a.name}:save`},t),await N(e,o),await Ke(a,e,o,r,s),await Promise.all([e.updateItemThumbnail(),k(e.resourceReferences,s)]),o}async function v(a,e,t){const o=ae(e,t,!0),r=a.write({},o);return await Promise.all(o.resources.pendingOperations),{json:r,jsonContext:o}}async function ve(a,e,t,o){o??(o={});const r=Re(a,t);await g(()=>!e.updatingFromView),await e.load(),await x(e),await D(e),await G(a,e);const{json:s,jsonContext:i}=await v(e,r,a.origin);V(i,{errorName:`${a.name}:save`},o),await Pe(e,r);const l=e.getThumbnailState();return await ze(a,e,r,s,i,o)&&(e.resourceReferences.portalItem=r),e.restoreThumbnailFromState(l),await Promise.all([e.updateItemThumbnail(),k(e.resourceReferences,i)]),r}function Ie(a,e){if(!e.portalItem)throw new w(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");j(a,e.portalItem)}function j(a,e){if(e.type!==a.itemType)throw new w(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}async function G(a,e){var o;if(a.name==="linkchart")return;if(!((o=e.basemap)!=null&&o.baseLayers.length))throw new w(`${a.name}:save`,"Map does not have a valid basemap with a base layer.");let t=null;if(await g(()=>{const r=ye(e.initialViewProperties,e.basemap);return t=r.spatialReference,!r.updating}),!oe(t,e.initialViewProperties.spatialReference))throw new w(`${a.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:t})}function Re(a,e){let t=re.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type=a.itemType),t.portal||(t.portal=ne.getDefault()),j(a,t),t}function x(a){const e=[];return a.basemap&&e.push(a.basemap.load()),a.ground&&e.push(a.ground.load()),Promise.allSettled(e).then(()=>{})}async function N(a,e){e.extent=await je(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),await Te(a,e)}const Se=b.JSAPI,B="CollectorDisabled",S="Collector",O="Data Editing",U="OfflineDisabled",A="Offline",F="Workforce Project",K="Workforce Worker",z="Workforce Dispatcher",Oe="Offline Map Areas",Ae="FieldMapsDisabled",P=b.DEVELOPER_BASEMAP,T="UtilityNetwork",W="IPS";async function Pe(a,e){c(e,B),c(e,Ae),c(e,b.METADATA),c(e,U),c(e,Oe),c(e,z),c(e,F),c(e,K),await N(a,e)}async function Te(a,e){d(e,Se),await We(a),Ce(a,e),De(a,e),Ve(a,e),ke(a,e),Me(a,e),Le(a,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,o,r)=>r.indexOf(t)===o))}function We(a){const e=I(a).map(t=>t.load()).toArray();return Promise.allSettled(e).then(()=>{})}function I(a){return a.allLayers.concat(a.allTables)}function H(a){return I(a).some(e=>e.loaded&&C(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some(t=>t.editingEnabled)))}function Ee(a){return I(a).filter(e=>e.type!=="group").every(e=>e.loaded&&Ne(a,e))}function Ce(a,e){h(e,B)||h(e,F)||h(e,K)||h(e,z)||!H(a)?c(e,S):d(e,S)}function De(a,e){H(a)?d(e,O):c(e,O)}function Ve(a,e){!h(e,U)&&Ee(a)?d(e,A):c(e,A)}function ke(a,e){we(a.basemap)?d(e,P):c(e,P)}function Me(a,e){var t;(t=a.utilityNetworks)!=null&&t.length?d(e,T):c(e,T)}function Le(a,e){a.ipsInfo?d(e,W):c(e,W)}async function je(a,e){const t=e.clone().normalize();let o;if(t.length>1)for(const r of t)o?r.width>o.width&&(o=r):o=r;else o=t[0];return Ge(a,o)}async function Ge(a,e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return le(e);const{getGeometryServiceURL:o}=await E(()=>import("./geometryServiceUtils-Cwj9muBm.js"),__vite__mapDeps([3,1,2])),r=await o(a),s=new ce({geometries:[e],outSpatialReference:pe.WGS84});return(await ue(r,s))[0]}function xe(a){return fe(a)||a.type==="map-notes"||a.type==="route"}function Ne(a,e){return C(e)&&e.capabilities.operations.supportsSync||xe(e)&&!e.portalItem||Be(e)&&!Ue(e)&&e.spatialReference.equals(a.initialViewProperties.spatialReference)}function Be(a){return(a.type==="tile"||a.type==="vector-tile")&&(a.capabilities.operations.supportsExportTiles||Fe(a)||he(a))}function Ue(a){return a.type==="vector-tile"&&Object.keys(a.sourceNameToSource).length>1}function Fe(a){return a.type==="tile"&&de(a.url)&&ge.some(e=>{var t;return(t=a.url)==null?void 0:t.toLowerCase().includes("/"+e+"/")})}async function Ke(a,e,t,o,r){await t.update({data:o}),q(a,e,t,o,r)}async function ze(a,e,t,o,r,s){const i=e.portalItem,l={item:i,authenticated:!(!(i!=null&&i.id)||!i.portal.user)},u=t.portal;await u.signIn();const{copyAllowed:p,itemReloaded:m}=await J(l,u);if(l.authenticated||(l.authenticated=m),!p)throw new w(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const n=await $(t,l,o,s);return e.portalItem=t,q(a,e,t,o,r),n}async function J(a,e){var r;const{item:t,authenticated:o}=a;return t!=null&&t.id&&((r=t.typeKeywords)!=null&&r.includes("useOnly"))?t.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await t.reload(),{copyAllowed:t.itemControl==="admin"||t.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function $(a,e,t,o){const r=a.portal,{item:s}=e,{folder:i,copyAllResources:l}=o;let u=!1;if(l&&(s!=null&&s.id)&&te(s.portal.url,r.url)&&parseInt(s.portal.currentVersion,10)>=2023){const{total:p}=await s.fetchResources();u=!!p}if(u){const p=await s.copy({copyResources:"all",folder:i});a.id=p.id,a.portal=p.portal;const m=a.toJSON();await a.load(),a.read(m),await a.update({data:t})}else await r.user.addItem({item:a,folder:i,data:t});return u}function q(a,e,t,o,r){se.prototype.read.call(e,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:t.itemUrl?ie(t.itemUrl):void 0}),me(r),e.resourceInfo=o}const Xe=Object.freeze(Object.defineProperty({__proto__:null,createJSON:v,initializeNewItem:$,isCopyAllowed:J,save:be,saveAs:ve},Symbol.toStringTag,{value:"Module"}));export{Qe as n,k as p,Xe as w};
